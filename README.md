# PushOccurrence

PushOccurrence ‚Äî —ç—Ç–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ Go, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å–æ–±—ã—Ç–∏—è—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (PostgreSQL) –≤ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π (RabbitMQ).

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–æ–±—ã—Ç–∏—è PostgreSQL (LISTEN/NOTIFY), –∏–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –∏–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≤ RabbitMQ, –∏—Å–ø–æ–ª—å–∑—É—è –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π (Publisher Confirms) –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

*   –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è –≤ –ë–î —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º LISTEN/NOTIFY.
*   –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
    *   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ FOR UPDATE SKIP LOCKED –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≥–æ–Ω–∫–∏ (race conditions) –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ.
    *   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ç RabbitMQ (Publisher Confirms).
    *   –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±—É—Ñ–µ—Ä –ø–∞–º—è—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±—Ä–æ–∫–µ—Ä–∞.
*   –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Å–µ—Ä–≤–∏—Å–∞ (–±–ª–∞–≥–æ–¥–∞—Ä—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º –≤ –ë–î).

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

*   Go: 1.25.4 –∏–ª–∏ –≤—ã—à–µ
*   PostgreSQL: –° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ö–µ–º –∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ NOTIFY.
*   RabbitMQ: –ë—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ AMQP 0.9.1.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã

1.  –°–æ–±—ã—Ç–∏–µ –≤ –ë–î: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –≤—Å—Ç–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥–∏—Ä—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã (message_queue_log, message_queue_log_data) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ NOTIFY <channel> '<message_id>'.
2.  –°–ª—É—à–∞—Ç–µ–ª—å (Listener): –°–µ—Ä–≤–∏—Å PushOccurrence, –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–∞ –∫–∞–Ω–∞–ª, –ø–æ–ª—É—á–∞–µ—Ç message_id.
3.  –û–±—Ä–∞–±–æ—Ç—á–∏–∫ (Handler):
    *   –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ message_queue_log –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    *   –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ message_queue_log_data.
    *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–∞–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏.
    *   –ü–æ–º–µ—á–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î –∫–∞–∫ transferred = true.
4.  –û—Ç–ø—Ä–∞–≤–∫–∞ (MQ Producer):
    *   –ü—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ RabbitMQ.
    *   –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (ACK) –æ—Ç –±—Ä–æ–∫–µ—Ä–∞.
    *   –í —Å–ª—É—á–∞–µ —Å–±–æ—è –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–≤—è–∑–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±—É—Ñ–µ—Ä –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö

–°–µ—Ä–≤–∏—Å –æ–∂–∏–¥–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—Ö–µ–º—ã data_exchange –∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü:

SQL

CREATE SCHEMA IF NOT EXISTS data_exchange;

-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE TABLE IF NOT EXISTS data_exchange.message_queue_log (
    message_id UUID PRIMARY KEY, -- –∏–ª–∏ –¥—Ä—É–≥–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (string)
    transferred BOOLEAN DEFAULT FALSE,
    transfer_time TIMESTAMP
);

-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
CREATE TABLE IF NOT EXISTS data_exchange.message_queue_log_data (
    message_id UUID REFERENCES data_exchange.message_queue_log(message_id),
    message_body BYTEA -- –∏–ª–∏ JSONB/TEXT
);


> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è message_id –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å (–≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è string).
## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ config/config.json. –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

JSON

{
  "postgres": {
    "host": "localhost",
    "port": 5432,
    "database": "your_db_name",
    "user": "your_db_user",
    "password": "your_db_password",
    "ssl_mode": "disable"
  },
  "rabbitmq": {
    "url": "amqp://guest:guest@localhost:5672/",
    "queue": {
      "name": "your_queue_name",
      "durable": true,
      "auto_delete": false,
      "exclusive": false,
      "no_wait": false
    },
    "retry": {
      "buffer_size": 100,
      "retry_delay_sec": 5,
      "idle_sleep_ms": 100
    }
  },
  "listener": {
    "channels": [
      "your_notify_channel"
    ]
  }
}


### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

*   postgres: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL.
*   rabbitmq:
    *   url: –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è AMQP.
    *   queue: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—á–µ—Ä–µ–¥–∏ (–¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≤ –±—Ä–æ–∫–µ—Ä–µ).
*   listener:
    *   channels: –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ PostgreSQL (LISTEN channel_name), –∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Å–ª—É—à–∞—Ç—å.

## ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫

1.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL –∏ RabbitMQ –∑–∞–ø—É—â–µ–Ω—ã.
2.  –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î (—Å–º. —Ä–∞–∑–¥–µ–ª "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö").
3.  –ù–∞—Å—Ç—Ä–æ–π—Ç–µ config/config.json.
4.  –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:

Bash

go run .cmd/app/


–ò–ª–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª:

Bash

go build -o bin/PushOccurrence .cmd/app
./bin/PushOccurrence


## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

.
‚îú‚îÄ‚îÄ cmd/app/main.go         # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ config/                 # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ JSON —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ db/                 # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, —Å–ª—É—à–∞—Ç–µ–ª—å, main loop)
‚îÇ   ‚îú‚îÄ‚îÄ handlers/           # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ mq/                 # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å RabbitMQ (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –±—É—Ñ–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–∞)
‚îÇ   ‚îî‚îÄ‚îÄ service/            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞
‚îî‚îÄ‚îÄ go.mod                  # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏


## ü§ù –í–∫–ª–∞–¥ –≤ —Ä–∞–∑–≤–∏—Ç–∏–µ (Contributing)

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã Go.
- –õ–∏–Ω—Ç–µ—Ä: golangci-lint (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: go fmt
